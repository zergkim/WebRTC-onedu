<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        input{
            outline: none;
        }
        input:invalid{
            border: 5px solid red;
        }
        #emailcer{
            display: none;
        }
    </style>
</head>
<body>
    <div><span>이름</span><input id="realname"></div>
    <div><span>생년월일(주민번호 앞자리+뒷자리 첫번째)</span><input id="jumindrungrok"></div>
    <div><span>성별</span><label><input type="radio" name="sex" id="sexselector">남</label><label><input type="radio" name="sex">여</label></div>
    <div>e-mail<input type="text" id="e-mail" required><button id="Certificationbtt">인증번호 보내기</button></div>
    <div id="passwordaid">id:<input type="text"><button>id중복확인</button>password:<input type="password"></div>
    <div id='emailcer'><span>이메일 인증번호(2분안에 만료)</span><input type="number"><button>확인하기</button></div>
    <button id="allconfirm">가입하기</button>
    <script>
        const realname = document.querySelector("#realname")
        const birth = document.querySelector("#jumindrungrok")
        const sex = document.querySelector("#sexselector")
        let flag={
            idbul :false,
            emailbul :false
        }
        const mail = document.querySelector('#e-mail');
        const cbtt = document.querySelector('#Certificationbtt')
        const cerdiv = document.querySelector("#emailcer")
        const cerbtt = document.querySelector("#emailcer>button")
        const cerinput  = document.querySelector("#emailcer>input")
        const emailar = [];
        const passwordaid = document.querySelector("#passwordaid")
        const idconfirm = passwordaid.querySelector("button")
        const idinp =passwordaid.querySelector("input[type='text']")
        const passwordinp = passwordaid.querySelector("input[type='password']")
        const allbutton = document.querySelector("#allconfirm")
        idconfirm.addEventListener("click",async e=>{
            const id_Text = idinp.value
            let fetch_id = await fetch("/id_unique",{
                method:"POST",
                headers:{
                    "Content-type":"text/plain"
                },
                body:id_Text
            })
            if(fetch_id.text()){
                flag.idbul=true;
                idinp.addEventListener("change",e=>{
                    flag.idbul=false
                })
            }
        })
        allbutton.addEventListener("click",async e=>{
            if(!flag.idbul){
                alert("id다시확인")
                return;
            }
            if(!flag.emailbul){
                alert("email다시확인")
                return;
            }
            let reqt = await fetch("/signinconfirm",
            {
                method:"POST",
                headers:{
                    "Content-Type":"application/json"
                },
                body:JSON.stringify({
                    
                    username:idinp.value,
                    sex:sex.value,
                    birth : birth.value,
                    passwords:passwordinp.value,
                    name:realname.value,
                    email : emailar[0]
                })
            })
            reqt = await reqt.text()
            if(reqt=="성공"){
                location.href="/login"
            }
        })
        const reg = /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/;
        mail.pattern = reg.source;
        const post_obj = function(body,type){
            const type_obj = {"file":"application/octet-stream","json":"application/json"}
            let temple = {
                method:"POST",
                headers:{
                    "Content-Type":type_obj[type]
                },
                body:JSON.stringify(body)
            }
            return temple;

        }
        const checkfunc = async e=>{
            let d = await(await fetch("/certpost",post_obj({EmailAdr:emailar[0],number:cerinput.value},"json"))).text()
            console.log(d)
            if(d){
                alert("성공")
                emailar
                flag.emailbul=true
            }
        }
        const cerefunc = async e=>{
            if(!mail.validity.valid){
                alert("이메일주소가 잘못됨!!!");
                cbtt.addEventListener("click",cerefunc,{once:true})
                return;
            }
            const email = mail.value;
            console.log(email)
            console.log(post_obj({email},"json"))
            if(await(await fetch("/email_send",post_obj({email},"json"))).text()){
                cerdiv.style.display="inherit"
                cerbtt.addEventListener("click",checkfunc)
                emailar.push(email)
            }else{
                alert("이메일 중복이다 애미뒤진년아 다른거 써라")
                cbtt.addEventListener("click",cerefunc,{once:true})
            }
            
        };
        
        cbtt.addEventListener("click",cerefunc,{once:true})
    </script>
</body>
<script>
    
</script>
</html>